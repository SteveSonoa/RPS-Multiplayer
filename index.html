<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

	<!-- Load Firebase -->
	<script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>


	<!-- Load Font Awesome -->
	<script src="https://use.fontawesome.com/e14e0f3537.js"></script>

	<!-- Load local files -->
	<link rel="stylesheet" type="text/css" href="assets/css/style.css">
	<script src="assets/javascript/data.js"></script>

	<title>Rock Paper Scissors</title>
</head>
<body>

	<!-- Headline header outside the container div -->
	<div class="panel panel-default">
		<div class="panel-body">
			<h1>Rock Paper Scissors</h1>
		</div>
	</div>

	<div class="container">
		<div class="row">
			<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" id="playerIntro"></div>
			<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" id="turnStatus"></div>
			<div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
				<div class="container-float">
					<div class="row" id="player1Stats">
						<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 stats" id="player1Name"></div>
						<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 stats choice" id="rock">Rock</div>
						<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 stats choice" id="paper">Paper</div>
						<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 stats choice" id="scissors">Scissors</div>
						<div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 aRight" id="player1LblWins"></div>
						<div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 aLeft" id="player1LblLosses"></div>
					</div>
				</div>
			</div>
			<div class="col-lg-4 col-md-4 col-sm-4 col-xs-12 stats" id="gameStats"></div>
			<div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
				<div class="container-float">
					<div class="row" id="player2Stats">
						<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 stats" id="player2Name"></div>
						<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 stats choice" id="rock"></div>
						<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 stats choice" id="paper"></div>
						<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 stats choice" id="scissors"></div>
						<div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 aRight" id="player2LblWins"></div>
						<div class="col-lg-6 col-md-6 col-sm-6 col-xs-6 aLeft" id="player2LblLosses"></div>
					</div>
				</div>

			</div>
			<div class="col-lg-2 col-md-2 col-sm-12 col-xs-12"></div>
			<div class="col-lg-10 col-md-10 col-sm-12 col-xs-12" id="chat">
				<textarea class="form-control" rows="6" id="chatTextArea"></textarea>
				<form class="form-horizontal">
					<div class="form-group col-lg-12 col-md-12 col-sm-12 col-xs-12">
						<input type="text" class="form-control" id="inputChatText" placeholder="Send A Message">
						<button type="submit" class="btn btn-default" id="chatSubmit">Send</button>
					</div>
				</form>
			</div>
			<div class="col-lg-2 col-md-2 col-sm-12 col-xs-12"></div>			
		</div>
	</div>

<script type="text/javascript">

	// Initialize Firebase
	var config = {
		apiKey: "AIzaSyAD0J15qtz5LDSLsrm1hBNAoZ4kP0cS_FY",
		authDomain: "stevesonoa-playground.firebaseapp.com",
		databaseURL: "https://stevesonoa-playground.firebaseio.com",
		projectId: "stevesonoa-playground",
		storageBucket: "",
		messagingSenderId: "1052450720326"
	};
	firebase.initializeApp(config);

	// Get a reference to the database service
	var database = firebase.database();

	var p1Wins = 0;
	var p1Losses = 0;
	var p1Name;
	var p1LoggedIn = true;
	var p1Choice = "none";

	var p2Wins = 0;
	var p2Losses = 0;
	var p2Name;
	var p2LoggedIn = true;
	var p2Choice = "none";

	var playerTurn = 1;
	var whoAmI = "none";

	database.ref().update({
		db_p1Wins: p1Wins, 
		db_p1Losses: p1Losses, 
		// db_p1Name: null, 
		db_p1LoggedIn: p1LoggedIn,
		db_p1Choice: p1Choice,

		db_p2Wins: p2Wins, 
		db_p2Losses: p2Losses, 
		// db_p2Name: null, 
		db_p2LoggedIn: p2LoggedIn,
		db_p2Choice: p2Choice
	});

	// Using .on("value", function(snapshot)) syntax will retrieve the data
    // from the database (both initially and every time something changes)
    // This will then store the data inside the variable "snapshot". We could rename "snapshot" to anything.
    database.ref().on("value", function(snapshot) {

		// Then we console.log the value of snapshot
		console.log(snapshot.val().db_p1LoggedIn);

		if(localStorage.getItem("whoAmI") != null) {
			whoAmI = localStorage.getItem("whoAmI");
			if(localStorage.getItem("p1Name") != null && whoAmI == "player1" && localStorage.getItem("p1Name") == snapshot.val().db_p1Name) {
				p1Name = snapshot.val().db_p1Name;
			}
			else if (localStorage.getItem("p2Name") != null && whoAmI == "player2" && localStorage.getItem("p2Name") == snapshot.val().db_p2Name){
				p2Name = snapshot.val().db_p2Name;
			}
		}

		if(snapshot.val().db_p1Name != null) {
			$("#player1Name").text(snapshot.val().db_p1Name);
			$("#player1LblWins").text("Wins: " + snapshot.val().db_p1Wins);
			$("#player1LblLosses").text("Losses: " + snapshot.val().db_p1Losses);
		}

		if(snapshot.val().db_p2Name != null) {
			$("#player2Name").text(snapshot.val().db_p2Name);
			$("#player2LblWins").text("Wins: " + snapshot.val().db_p2Wins);
			$("#player2LblLosses").text("Losses: " + snapshot.val().db_p2Losses);
		}		

		if(snapshot.val().db_p1Choice != "none") {
	    	// Then we change the html associated with the number.
	    	$("#gameStats").text("Player 1: " + snapshot.val().db_p1Choice);
	    }

		if(whoAmI == "none" && snapshot.val().db_p1Name == null) {
			drawPlayerNameInput("player1");
		}
		else if(whoAmI == "none" && snapshot.val().db_p2Name == null) {
			drawPlayerNameInput("player2");
		}
		else {
			drawPlayerNameDisplay();
		}

    	// Then update the clickCounter variable with data from the database.
    	p1Choice = snapshot.val().db_p1Choice;

    // If there is an error that Firebase runs into -- it will be stored in the "errorObject"
    // Again we could have named errorObject anything we wanted.
    }, function(errorObject) {

    	// In case of error this will print the error
    	console.log("The read failed: " + errorObject.code);
    });

	$(document).on("click", ".choice", function() {

		p1Choice = $(this).attr("id");
		console.log(p1Choice);

		database.ref().update({
			db_p1Choice: p1Choice
		});
	});

	$(document).on("click", ".btnPlayerNameInput", function() {
		event.preventDefault();

		if($(this).attr("id") == "player1") {
			p1Name = $("#playerNameInput").val().trim();
			database.ref().update({
				db_p1Name: p1Name
			});
			
			whoAmI = "player1";
			localStorage.setItem("whoAmI", "player1");
			localStorage.setItem("p1Name", p1Name);
			drawPlayerNameDisplay();
			console.log(p1Name);
		}
		else if($(this).attr("id") == "player2") {
			p2Name = $("#playerNameInput").val().trim();
			database.ref().update({
				db_p2Name: p2Name
			});

			localStorage.setItem("whoAmI", "player2");
			localStorage.setItem("p2Name", p2Name);
			whoAmI = "player2";
			drawPlayerNameDisplay();
		}
	});

	function drawPlayerNameInput(whichPlayer) {
    	$("#playerIntro").html(
			'<form class="form-inline">'
		+		'<div class="form-group">'
		+			'<input type="text" class="form-control" id="playerNameInput" placeholder="Your Name">'
		+		'</div>'
		+		'<button type="submit" class="btn btn-default btnPlayerNameInput" id="' + whichPlayer + '">Start</button>'
		+	'</form>'
		);
	}

	function drawPlayerNameDisplay() {
		if(whoAmI == "none") {
			$("#playerIntro").html("You are currently spectating.");
		}
		else if(whoAmI == "player1") {
			$("#playerIntro").html("Hi, " + p1Name + "! You are player 1.");
		}
		else if(whoAmI == "player2") {
			$("#playerIntro").html("Hi, " + p2Name + "! You are player 2.");
		}
	}

	// $(window).unload(function(){
	// 	localStorage.removeItem("whoAmI");
	// });

</script>


</body>
</html>